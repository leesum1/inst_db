# Web UI for Instruction Database

这是一个基于 Flask 的 Web 可视化工具，用于分析和探索指令执行轨迹数据库。

## 功能特性

✨ **核心功能**
- 📤 **数据库上传**: 支持拖拽或点击上传 `.db`, `.sqlite`, `.sqlite3` 格式的数据库文件
- 📊 **指令列表**: 分页展示所有指令，支持排序和筛选
- 🔍 **搜索过滤**: 按 PC 地址、反汇编文本或寄存器名称进行搜索
- 📋 **指令详情**: 查看单条指令的完整信息，包括寄存器依赖和内存操作
- 🌲 **依赖链可视化**: 查询和展示源寄存器依赖的指令链（树形结构）
- 💾 **数据导出**: 支持将指令数据导出为 JSON 或 CSV 格式

## 快速开始

### 1. 安装依赖

确保已安装 Flask：

```bash
pip install flask
# 或者安装项目所有依赖
pip install -e .
```

### 2. 启动 Web 服务器

从项目根目录运行：

```bash
python -m inst_db.web_ui.app
```

或者指定主机和端口：

```bash
python -m inst_db.web_ui.app --host 0.0.0.0 --port 8080 --debug
```

**命令行参数**：
- `--host`: 绑定的主机地址（默认: `127.0.0.1`）
- `--port`: 绑定的端口（默认: `5000`）
- `--debug`: 启用调试模式

### 3. 访问 Web UI

打开浏览器访问：
```
http://127.0.0.1:5000
```

## 使用指南

### 上传数据库

1. 在主页点击"选择文件"按钮或直接拖拽 `.db` 文件到上传区域
2. 等待文件上传和加载完成
3. 系统会自动显示数据库统计信息

### 浏览指令列表

- **分页**: 使用底部的分页控件浏览不同页面
- **排序**: 点击表头（Sequence ID 或 PC）进行排序
- **每页显示**: 在下拉框中选择每页显示的指令数量（25/50/100/200）

### 搜索和过滤

- **文本搜索**: 在搜索框输入 PC 地址（如 `0x4000`）或反汇编文本（如 `mov`）
- **寄存器筛选**: 从下拉列表选择特定寄存器，只显示涉及该寄存器的指令
- **应用过滤**: 点击"应用过滤"按钮执行查询
- **重置**: 点击"重置"按钮清除所有过滤条件

### 查看指令详情

1. 点击指令行右侧的 **"详情"** 按钮
2. 弹窗显示：
   - 基本信息（Sequence ID、PC、反汇编、指令码）
   - 寄存器依赖（标记为 SRC 源寄存器或 DST 目标寄存器）
   - 内存操作（地址、类型、长度）

### 查看依赖链

1. 点击指令行右侧的 **"依赖链"** 按钮
2. 在弹窗中：
   - **设置深度**: 调整"最大深度"参数（默认 10，最大 50）
   - **切换格式**: 勾选"文本格式"在树形图和纯文本间切换
   - **刷新**: 修改参数后点击"刷新"按钮重新加载
3. 依赖树展示规则：
   - 根节点为目标指令（紫色背景）
   - 每个节点显示 `[sequence_id] PC 反汇编 (reg: 寄存器名)`
   - 循环依赖节点标记为 `[cycle]`（红色边框）

### 导出数据

- 点击 **"导出 JSON"** 或 **"导出 CSV"** 按钮
- 导出内容会应用当前的搜索和过滤条件
- 文件自动下载到本地

## 技术架构

### 后端（Flask）

- **app.py**: Flask 应用主程序，定义所有 API 路由
- **config.py**: 配置文件（上传大小、分页、依赖深度等）
- **utils/db_handler.py**: 数据库会话管理和查询
- **utils/dependency_graph.py**: 依赖树构建算法（复用自 `test.py`）

### 前端

- **templates/index.html**: 主页面模板
- **static/app.js**: 前端 JavaScript 逻辑
- **static/style.css**: 响应式 CSS 样式

### API 端点

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/upload` | POST | 上传数据库文件 |
| `/api/instructions` | GET | 获取指令列表（分页、过滤） |
| `/api/instruction/<seq_id>` | GET | 获取单条指令详情 |
| `/api/instruction/<seq_id>/dependencies` | GET | 获取依赖链树 |
| `/api/registers` | GET | 获取所有寄存器列表 |
| `/api/statistics` | GET | 获取数据库统计信息 |
| `/api/export` | GET | 导出指令数据 |
| `/api/close` | GET | 关闭当前数据库会话 |

## 配置选项

在 [config.py](config.py) 中可以调整：

```python
# 上传配置
MAX_CONTENT_LENGTH = 500 * 1024 * 1024  # 最大上传文件大小 (500 MB)
ALLOWED_EXTENSIONS = {"db", "sqlite", "sqlite3"}

# 分页配置
DEFAULT_PAGE_SIZE = 50  # 默认每页显示数量
MAX_PAGE_SIZE = 500     # 最大每页显示数量

# 依赖查询配置
DEFAULT_MAX_DEPTH = 10  # 默认依赖深度
MAX_DEPTH_LIMIT = 50    # 最大依赖深度限制
```

## 依赖查询算法

依赖链查询基于 [tmp/test.py](../../tmp/test.py) 中的实现：

1. **查询源寄存器**: 找出目标指令读取的所有源寄存器（`is_src=1`）
2. **查找写入指令**: 在目标指令之前，找出所有写入这些寄存器的指令（`is_dst=1`）
3. **取最近写入**: 对每个寄存器，使用 SQL 窗口函数取 `sequence_id` 最大的写入指令
4. **递归构建树**: BFS 遍历构建多层依赖树，检测并标记循环依赖

核心 SQL 查询使用 CTE（Common Table Expression）和窗口函数优化性能。

## 示例使用场景

### 场景 1: 分析特定指令的数据流

1. 上传 `sve_trace.db`
2. 在搜索框输入 `4420`（sequence_id）
3. 点击"查看依赖链"
4. 设置深度为 20
5. 分析寄存器数据从哪些指令流入

### 场景 2: 查找所有涉及某寄存器的指令

1. 在"寄存器筛选"下拉框选择 `x0`
2. 点击"应用过滤"
3. 浏览所有读取或写入 `x0` 的指令

### 场景 3: 导出分析结果

1. 应用搜索/过滤条件
2. 点击"导出 CSV"
3. 在 Excel 或其他工具中进一步分析

## 注意事项

⚠️ **安全提示**
- 当前版本使用 Flask 开发服务器，**不适合生产环境部署**
- 生产环境请使用 Gunicorn、uWSGI 等 WSGI 服务器
- 建议在受信任的网络环境中使用

⚠️ **性能考虑**
- 超大数据库（> 100 万条指令）可能导致查询缓慢
- 依赖深度过大会显著增加查询时间
- 建议首次使用较小的深度值（< 15）

## 故障排除

### 问题：上传失败

- 检查文件格式是否为 `.db`, `.sqlite`, `.sqlite3`
- 确认文件大小不超过 500 MB
- 检查文件是否为有效的 SQLite 数据库

### 问题：依赖链查询超时

- 减小"最大深度"参数
- 检查数据库是否有索引（`sequence_id`, `register_name`）
- 尝试查询依赖较少的指令

### 问题：页面无法加载

- 确认 Flask 服务正在运行
- 检查端口是否被占用
- 查看终端日志中的错误信息

## 扩展开发

### 添加新的 API 端点

在 [app.py](app.py) 中添加新的路由：

```python
@app.route("/api/your-endpoint")
def your_endpoint():
    # 实现逻辑
    return jsonify({"result": "data"})
```

### 自定义前端样式

修改 [static/style.css](static/style.css) 中的样式定义。

### 集成其他可视化库

在 [static/app.js](static/app.js) 中集成 D3.js、ECharts 等库，实现更复杂的交互式可视化。

## 许可证

本项目遵循 MIT 许可证。
